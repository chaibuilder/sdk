import react from "@vitejs/plugin-react-swc";
import path, { resolve } from "path";
import { defineConfig } from "vite";
import dts from "vite-plugin-dts";
import express from "./src/express/express-plugin";

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    react(),
    dts({
      include: ["src/**/*"],
      exclude: ["**/*.test.*", "**/*.spec.*"],
      rollupTypes: true,
      insertTypesEntry: true,
    }),
    express("./src/express/index.ts"),
  ],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  build: {
    emptyOutDir: true,
    lib: {
      entry: {
        core: resolve(__dirname, "src/core/main/index.ts"),
        render: resolve(__dirname, "src/render/index.ts"),
        "web-blocks": resolve(__dirname, "src/web-blocks/index.ts"),
        runtime: resolve(__dirname, "src/runtime.ts"),
        pages: resolve(__dirname, "src/pages/index.ts"),
        actions: resolve(__dirname, "src/actions/export.ts"),
        utils: resolve(__dirname, "src/utils/index.ts"),
        "supabase-actions": resolve(__dirname, "src/express/actions/storage/index.ts"),
      },
      formats: ["es", "cjs"],
    },
    rollupOptions: {
      treeshake: true,
      output: {
        exports: "named",
        globals: {
          "react-dom": "ReactDom",
          react: "React",
          "react/jsx-runtime": "ReactJsxRuntime",
        },
      },

      // make sure to externalize deps that shouldn't be bundled
      // into your library
      external: [
        "react/jsx-runtime",
        "react/jsx-dev-runtime",
        "drizzle-orm",
        "drizzle-orm/pg-core",
        "drizzle-orm/postgres-js",
        "postgres",
        "crypto",
        "node:crypto",
        "path",
        "os",
        "fs",
        "net",
        "tls",
        "stream",
        "perf_hooks",
        "sharp",
        "@floating-ui/dom",
        "@floating-ui/react-dom",
        "react-error-boundary",
        "@mhsdesign/jit-browser-tailwindcss",
        "@radix-ui/react-accordion",
        "@radix-ui/react-alert-dialog",
        "@radix-ui/react-avatar",
        "@radix-ui/react-checkbox",
        "@radix-ui/react-context-menu",
        "@radix-ui/react-dialog",
        "@radix-ui/react-dropdown-menu",
        "@radix-ui/react-hover-card",
        "@radix-ui/react-icons",
        "@radix-ui/react-label",
        "@radix-ui/react-menubar",
        "@radix-ui/react-navigation-menu",
        "@radix-ui/react-popover",
        "@radix-ui/react-scroll-area",
        "@radix-ui/react-select",
        "@radix-ui/react-separator",
        "@radix-ui/react-slot",
        "@radix-ui/react-slider",
        "@radix-ui/react-switch",
        "@radix-ui/react-tabs",
        "@radix-ui/react-toast",
        "@radix-ui/react-toggle",
        "@radix-ui/react-tooltip",
        "@react-hookz/web",
        "react-arborist",
        "jotai/utils",
        "sonner",
        "sharp",
        "@rjsf/core",
        "react-hook-form",
        "@hookform/resolvers",
        "@rjsf/utils",
        "@iconify-json/lucide",
        "@rjsf/validator-ajv8",
        "@tanstack/react-virtual",
        "@tailwindcss/aspect-ratio",
        "@tailwindcss/forms",
        "@tailwindcss/line-clamp",
        "@tailwindcss/typography",
        "@tailwindcss/container-queries",
        "class-variance-authority",
        "@bobthered/tailwindcssPaletteGenerator",
        "clsx",
        "cmdk",
        "framer-motion",
        "date-fns",
        "flagged",
        "fuse.js",
        "himalaya",
        "tree-model",
        "i18next",
        "jotai",
        "prop-types",
        "lodash",
        "lodash-es",
        "culori",
        "react",
        "react-autosuggest",
        "react-colorful",
        "react-dom",
        "react-frame-component",
        "react-hotkeys-hook",
        "react-i18next",
        "react-json-view",
        "@tiptap/react",
        "@tiptap/pm",
        "@tiptap/extension-link",
        "@tiptap/starter-kit",
        "@tiptap/extension-underline",
        "@tiptap/extension-text-align",
        "@tiptap/extension-bullet-list",
        "@tiptap/extension-ordered-list",
        "@tiptap/extension-placeholder",
        "@tiptap/extension-text-align",
        "@tiptap/extension-text-style",
        "@tiptap/extension-highlight",
        "react-wrap-balancer",
        "tailwind-merge",
        "tailwindcss-animate",
        "undo-manager",
        "zod",
        "nanoid",
        "monaco-editor",
        "@monaco-editor/react",
        "use-stick-to-bottom",
        "streamdown",
        "lucide-react",
        "motion",
        "@tanstack/react-query",
        "@radix-ui/react-use-controllable-state",
        "compressorjs",
        "canvas-confetti",
        "react-filerobot-image-editor",
        "react-dropzone",
        "date-fns",
        "react-diff-view",
        "@radix-ui/react-collapsible",
        "react-error-boundary",
        "next",
      ],
    },
  },
});
